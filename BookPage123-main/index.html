<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç¹ªæœ¬é–±è®€</title>

  <style>
    /* ---------- å…¨å±€åŸºç¤æ¨£å¼ ---------- */
    body {
      margin: 0;
      background-color: #363636;
      font-family: Arial, sans-serif;
      color: white;
    }

    /* ---------- è®“ #app-content æ•´é«”ç½®ä¸­ ---------- */
    #app-content {
      display: flex;
      flex-direction: column;
      align-items: center;   /* æ°´å¹³ç½®ä¸­ */
      min-height: 100vh;
      box-sizing: border-box;
      padding: 20px 0;
    }

    /* ---------- é€²åº¦æ¢ + é ç¢¼ (ç½®ä¸­) ---------- */
    .progress-bar {
      width: 80%;
      max-width: 1200px;
      margin: 0 auto 10px;   /* æ°´å¹³ç½®ä¸­ï¼Œä¸‹æ–¹ç•™ 10px */
      text-align: center;
      position: relative;
    }
    .progress-bar progress {
      width: 100%;
      height: 10px;
    }
    #page-number-display {
      font-size: 18px;
      margin-top: 5px;
      color: #ffffff;
    }

    /* ---------- æ’­æ”¾æœ—è®€æŒ‰éˆ• ---------- */
    #audio-controls {
      text-align: center;
      margin-bottom: 20px;
    }
    #play-audio {
      padding: 8px 16px;
      font-size: 16px;
      background-color: #3a7ce6;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #play-audio:hover {
      background-color: #2958a3;
    }
    #page-audio {
      display: none;
    }

    /* ---------- ç¿»é å™¨å®¹å™¨ï¼šä»¥ margin:0 auto æ°´å¹³ç½®ä¸­ ---------- */
    #flipbook-container {
      position: relative;
      display: block;       
      margin: 0 auto;       /* è®“ç¿»é å™¨æ°´å¹³ç½®ä¸­ */
    }

    #flipbook {
      background-color: #ffffff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    /* ---------- å·¦å³ç¿»é æŒ‰éˆ• (å›ºå®šåœ¨å®¹å™¨å…©å´) ---------- */
    .arrow-button {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      padding: 10px;
      font-size: 24px;
      background-color: #3a7ce6;
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      transition: background-color 0.3s ease;
      z-index: 1000;
      width: 50px;
      height: 50px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .arrow-button:hover {
      background-color: #2958a3;
    }
    #pdf-prev {
      left: 10px;   
    }
    #pdf-next {
      right: 10px;  
    }
    @media (max-width: 768px) {
      .arrow-button {
        width: 40px;
        height: 40px;
        padding: 5px;
        font-size: 18px;
      }
    }

    /* ---------- å–®å¼µé é¢ (.page) ---------- */
    .page {
      position: relative;
      z-index: 1;
    }
    /* ç¬¬ 1 é æ™‚éš±è—å·¦åŠé ï¼Œè®“å³é è²¼å·¦ */
    #flipbook.first-page .page-left {
      display: none !important;
    }
    #flipbook.first-page .page-right {
      margin-left: 0 !important;
      display: block !important;
    }

    /* ---------- Loading æ—‹è½‰å‹•ç•« ---------- */
    #loading-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      position: fixed;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.8);
      z-index: 1000;
    }
    .spinner {
      width: 80px;
      height: 80px;
      border: 5px solid rgba(0, 0, 0, 0.2);
      border-top: 5px solid #000;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0%   { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ---------- DIVE & Embed å…¨è¢å¹•å®¹å™¨ ---------- */
    #dive-container, #embed-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    /* æŠŠå¯¬åº¦å¾åŸæœ¬ 90% æ”¹æˆ 80%ï¼Œä¸¦æŠŠ max-width å¾ 1000px æ”¹ç‚º 800px */
    #dive-frame, #embed-frame {
      width: 80%;
      max-width: 800px;
      max-height: 80%;
      border: 2px solid #333;
      aspect-ratio: 4/3;
      background: white;
    }
    #dive-buttons, #embed-buttons {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10000;
      display: flex;
      gap: 10px;
    }
    #dive-buttons button, #embed-buttons button {
      margin: 5px;
      padding: 8px 12px;
      border-radius: 5px;
      background-color: #3a7ce6;
      color: white;
      font-size: 14px;
      border: none;
      cursor: pointer;
    }

        #notice-overlay {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 99999;
    }
    #notice-box {
      background: white;
      color: black;
      padding: 30px;
      width: 90%;
      max-width: 600px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      overflow-y: auto;
      max-height: 80vh;
    }
    #notice-box h2, #notice-box h3 { margin-top: 15px; }
    #notice-box button {
      margin-top: 20px;
      padding: 10px 20px;
      background: #3a7ce6;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    /* ---------- å³ä¸Šè§’ã€Œé–±è®€é ˆçŸ¥ã€æŒ‰éˆ• ---------- */
    #notice-button {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      padding: 8px 16px;
      background: #3a7ce6;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #notice-button:hover { background: #2958a3; }

  </style>

  <!-- å¼•å…¥å¤–éƒ¨å‡½å¼åº«ï¼šjQuery / turn.js / PDF.js / DIVE Linker -->
  <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
  <script src="js/turn.js"></script>
  <script src="pdf.js"></script>
  <script src="pdf.worker.js"></script>
  <script src="https://dive.nutn.edu.tw/Experiment/js/dive.linker.js"></script>
  <script src="js/dive.js"></script>
  <!-- Font Awesome (ç”¨ä¾†é¡¯ç¤ºç®­é ­ icon) -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
</head>

<body>
  <!-- æ³¨æ„äº‹é …å½ˆçª— -->
  <div id="notice-overlay">
    <div id="notice-box">
      <h2>ğŸ“– é–±è®€å‰é ˆçŸ¥</h2>
      <p>è¦ªæ„›çš„è®€è€…æ‚¨å¥½ï¼Œ<br>
      ã€Œè¨˜å¾—ä½ ï¼Œå¿˜è¨˜æˆ‘ã€æœ‰æ•…äº‹ä¹Ÿæœ‰äº’å‹•å°é—œå¡ï¼Œè«‹æ‚¨æ…¢æ…¢çœ‹ï¼Œäº«å—å…¶ä¸­ã€‚</p>

      <h3>ğŸ§­ é–±è®€æ–¹å¼</h3>
      <ul>
        <li>ç¹ªæœ¬è«‹å¾å·¦çœ‹åˆ°å³ã€å¾ä¸Šçœ‹åˆ°ä¸‹ã€‚</li>
        <li>æ¯ä¸€é æˆ‘å€‘ä¸€èµ·æ…¢æ…¢æ»‘ã€æ…¢æ…¢çœ‹ï¼Œæ²ˆæµ¸å…¶ä¸­ï¼</li>
      </ul>

      <h3>ğŸ“± æ“ä½œæ–¹å¼</h3>
      <ul>
        <li>çœ‹åˆ° QR CODE æ™‚ï¼Œè«‹é»ä¸€ä¸‹ï¼ˆæˆ–è«‹å®¶äººå¹«å¿™é»ï¼‰ï¼Œæœƒè·³å‡ºä¸€å€‹å°éŠæˆ²æˆ–ä»»å‹™ã€‚</li>
        <li>ä»»å‹™åšå®Œå¾Œï¼Œè«‹å›åˆ°ç¹ªæœ¬ï¼Œç¹¼çºŒçœ‹ä¸‹ä¸€é ã€‚</li>
      </ul>

      <h3>ğŸ”Š å°å®åš€</h3>
      <ul>
        <li>æ¯é çš„èªéŸ³åœ–ç¤ºï¼Œå»ºè­°æ‚¨é»ä¸€ä¸‹ï¼Œæœƒæœ‰æº«æŸ”çš„è²éŸ³å¿µçµ¦æ‚¨è½ã€‚</li>
        <li>å¦‚æœæ‚¨ä½¿ç”¨å¹³æ¿æˆ–é›»è…¦ï¼Œç•«é¢æœƒæ›´æ¸…æ¥šã€æ¯”è¼ƒå¥½æ“ä½œå–”ï¼</li>
      </ul>

      <p>ğŸ’› æ´»çµ¡ä¸€ä¸‹é ­æ®¼ï¼Œå…äºˆç”ŸéŠ¹<br>
      ğŸ’› æœ‰å•¥å¿ƒäº‹ï¼Œå’±è¬›å‡ºä¾†å°±è¼ƒé¬†å¿«<br>
      ğŸ’› æƒ³æƒ³å®¶å·±äººï¼Œå½¼å€‹å¿ƒè‚å¯¶è²å’§</p>

      <p>æ¯ä¸€é—œï¼Œéƒ½åƒæ˜¯åœ¨ä¿®è£œä¸€æ®µå›æ†¶ï¼Œ<br>
      ä¹Ÿè¨±æ¨¡ç³Šäº†ï¼Œä½†æ„›ä¸æœƒå¿˜ã€‚</p>

      <p>âœ§ é¡˜æ‚¨çœ‹å¾—é–‹å¿ƒï¼Œä¹Ÿæƒ³èµ·å¿ƒä¸­æœ€é‡è¦çš„äºº âœ§<br>
      è£½ä½œåœ˜éšŠæ•¬ä¸Š<br>
      ã€Šè¨˜å¾—ä½ ï¼Œå¿˜è¨˜æˆ‘ã€‹</p>

      <button onclick="closeNotice()">é—œé–‰</button>
    </div>
  </div>

  <button id="notice-button">é–±è®€é ˆçŸ¥</button>

  <!-- Loading ç•«é¢ -->
  <div id="loading-screen"><div class="spinner"></div></div>

  <!-- ä¸»è¦ App å…§å®¹ (æ°´å¹³ç½®ä¸­) -->
  <div id="app-content" style="display: none;">

    <!-- é ç¢¼ + é€²åº¦æ¢ -->
    <div class="progress-bar">
      <progress id="reading-progress" value="0" max="100"></progress>
      <p id="page-number-display">
        ç¬¬ <span id="pdf-current-page">1</span> é ï¼Œå…± <span id="pdf-total-pages"></span> é 
      </p>
    </div>

    <!-- æ’­æ”¾æœ—è®€æŒ‰éˆ• -->
    <div id="audio-controls">
      <button id="play-audio">æ’­æ”¾ç•¶é æœ—è®€</button>
      <audio id="page-audio"></audio>
    </div>

    <!-- ç¿»é å™¨å®¹å™¨ï¼šdisplay:block + margin:0 auto -->
    <div id="flipbook-container">
      <div id="flipbook"></div>

      <!-- å·¦å³ç¿»é æŒ‰éˆ• -->
      <button id="pdf-prev" class="arrow-button">
        <i class="fas fa-arrow-left"></i>
      </button>
      <button id="pdf-next" class="arrow-button">
        <i class="fas fa-arrow-right"></i>
      </button>
    </div>

    <!-- DIVE å…¨è¢å¹•å®¹å™¨ -->
    <div id="dive-container">
      <iframe id="dive-frame" name="dive"></iframe>
      <div id="dive-buttons">
        <button onclick="closeDive()">é—œé–‰éŠæˆ²</button>
        <button onclick="restartDive()">é‡æ–°æ•´ç†</button>
      </div>
    </div>

    <!-- Embed å…¨è¢å¹•å®¹å™¨ -->
    <div id="embed-container">
      <iframe id="embed-frame"></iframe>
      <div id="embed-buttons">
        <button onclick="closeEmbed()">é—œé–‰</button>
        <button onclick="reloadEmbed()">é‡æ–°æ•´ç†</button>
      </div>
    </div>
  </div>

  <script>
    function openNotice(){ $('#notice-overlay').css('display','flex'); }
    function closeNotice(){ $('#notice-overlay').hide(); }
    window.addEventListener('load', openNotice);
    $('#notice-button').click(openNotice);

    // ========== å¸¸æ•¸ & å…¨åŸŸè®Šæ•¸ ==========
    const BOOK_FILENAME = 'book.pdf'; // åªè¼‰å…¥é€™æœ¬ PDF
    let __PDF_DOC, __CURRENT_PAGE = 1, __TOTAL_PAGES = 0, __PAGE_WIDTH = 0, __PAGE_HEIGHT = 0;
    let __BATCH_SIZE = 2, __CURRENT_BATCH = 1; 
    // æŠŠæ‰¹æ¬¡å¤§å°å¾ 3 æ”¹æˆ 2ï¼Œè®“ç€è¦½å™¨ä¸€æ¬¡åªæ¸²æŸ“å…©é ï¼Œæ¸›è¼•å³°å€¼è² è¼‰
    let linkRegions = [];

    // åœ¨ç¬¬ 29 é èˆ‡ç¬¬ 55 é é¡¯ç¤º QR codeï¼Œä¸¦å°æ‡‰åˆ° DIVE éŠæˆ² 33325ã€33326
    const diveLinkPages = {
      '29': {
        left:  1500 + 'px',  
        top:   800 + 'px',  
        width:  '200px',
        height: '200px',
        projectId: 33325,
        imagePath: 'qrcodes/qr29.png'
      },
      '55': {
        left:  1500 + 'px',  
        top:   700 + 'px',  
        width:  '200px',
        height: '200px',
        projectId: 33326,
        imagePath: 'qrcodes/qr55.png'
      }
    };


    // ç›®å‰ä¸æ‰“ç®—åœ¨å…¶ä»–é åµŒå…¥ç¶²é ï¼Œæ•…å…ˆç•™ç©º
    const embedLinkPages = {};

    // ========== æ¸²æŸ“å–®ä¸€ PDF é é¢åˆ° Canvas ==========
    function renderPage(page, canvas, scale = 1.5) {
      // å°‡ scale å¾åŸæœ¬ 2 é™åˆ° 1.5ï¼Œé™ä½æ¸²æŸ“è² è¼‰ã€‚
      if (!canvas) return Promise.reject('æ‰¾ä¸åˆ°å°æ‡‰çš„ canvas å…ƒç´ ');
      ResizeflipCanvasSize();
      updateProgressBar();

      let viewport = page.getViewport(scale);
      let ctx = canvas.getContext('2d');
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      return page.render({ canvasContext: ctx, viewport: viewport }).promise;
    }

    // ========== æ‰¹æ¬¡æ¸²æŸ“å¤šé  ==========
    function renderBatch(startPage, endPage) {
      ResizeflipCanvasSize();
      let chain = Promise.resolve();
      for (let i = startPage; i <= endPage; i++) {
        chain = chain.then(() => {
          return __PDF_DOC.getPage(i).then(page => {
            let canvas = document.getElementById('canvas' + i);
            return new Promise(resolve => {
              // å¦‚æœ canvas å°šæœªå‡ºç¾ï¼Œå°±ç”¨ MutationObserver ç­‰å¾…
              if (canvas) return resolve(canvas);
              const obs = new MutationObserver((mutations, observer) => {
                let found = document.getElementById('canvas' + i);
                if (found) {
                  observer.disconnect();
                  resolve(found);
                }
              });
              obs.observe(document.getElementById('flipbook'), { childList: true, subtree: true });
            }).then(cnv => renderPage(page, cnv))
              .catch(err => console.error('æ¸²æŸ“ç¬¬ ' + i + ' é å‡ºéŒ¯ï¼š', err));
          });
        });
      }
      return chain;
    }

    // ========== ä¾æ‰¹æ¬¡è¼ªæµæ¸²æŸ“æ‰€æœ‰é  ==========
    function renderPagesInBatches() {
      let total = Math.ceil(__TOTAL_PAGES / __BATCH_SIZE);
      function nextBatch() {
        if (__CURRENT_BATCH > total) return;
        let start = (__CURRENT_BATCH - 1) * __BATCH_SIZE + 1;
        let end = Math.min(__CURRENT_BATCH * __BATCH_SIZE, __TOTAL_PAGES);
        renderBatch(start, end).then(() => {
          __CURRENT_BATCH++;
          setTimeout(nextBatch, 1000);
        });
      }
      nextBatch();
    }

    // ========== é¡¯ç¤º PDF ==========
    function showPDF() {
      let url = `./pdfs/${BOOK_FILENAME}`;
      PDFJS.getDocument({ url }).then(pdfDoc => {
        __PDF_DOC = pdfDoc;
        __TOTAL_PAGES = pdfDoc.numPages;
        document.getElementById('pdf-total-pages').textContent = __TOTAL_PAGES;

        // å…ˆè®€ç¬¬ 1 é å–å¾—å¯¬é«˜
        return pdfDoc.getPage(1).then(page => {
          let vp = page.getViewport(1.33);
          __PAGE_WIDTH = vp.width;
          __PAGE_HEIGHT = vp.height;

          // æ¸…ç©ºå†æ’å…¥æ‰€æœ‰ <div class="page"><canvas></canvas></div>
          $('#flipbook').empty();
          for (let i = 1; i <= __TOTAL_PAGES; i++) {
            $('#flipbook').append(
              `<div class="page" data-page="${i}">
                  <canvas id="canvas${i}" width="${__PAGE_WIDTH}px"></canvas>
               </div>`
            );
          }

          // å‘¼å« turn.jsï¼Œä¸€å®šè¦åœ¨æ‰€æœ‰ .page éƒ½æ’å…¥å¾Œ
          $('#flipbook').turn({
            width: __PAGE_WIDTH * 2,
            height: __PAGE_HEIGHT,
            autoCenter: true
          });

          bindFlipbookEvents();
          ResizeflipCanvasSize();
          renderPagesInBatches();
        });
      }).catch(err => {
        console.error('è¼‰å…¥ PDF æ™‚å‡ºéŒ¯ï¼š', err);
        alert('PDF è¼‰å…¥å¤±æ•—ï¼š' + err.message);
      });
    }

    // ========== ç¶å®šç¿»é äº‹ä»¶ ==========
    function bindFlipbookEvents() {
      $('#flipbook').bind('turning', (event, page, view) => {
        __CURRENT_PAGE = page;
        document.getElementById('pdf-current-page').textContent = page;
        updateProgressBar();

        // ç¬¬ 1 é æ™‚éš±è—å·¦åŠé ï¼Œè®“å³åŠé é å·¦é¡¯ç¤º
        if (page === 1) {
          $('#flipbook').addClass('first-page');
        } else {
          $('#flipbook').removeClass('first-page');
        }
        ResizeflipCanvasSize();

        // ç¿»é å¾Œæ¸…é™¤èˆŠçš„é€£çµï¼Œé‡æ–°æ’å…¥ DIVE/Embed
        clearLinkRegions();
        handlePageLinks(view, diveLinkPages);
        handleEmbedLinks(view, embedLinkPages);
      });
    }

    // ========== æ¸…é™¤èˆŠçš„ DIVE/Embed é€£çµå€ ==========
    function clearLinkRegions() {
      linkRegions.forEach(item => item.element.remove());
      linkRegions = [];
    }

    // ========== æ’å…¥ DIVE é€£çµ ==========
    function handlePageLinks(view, pagesConfig) {
      view.forEach(p => {
        let key = p.toString();
        if (pagesConfig[key]) addDiveLinkToPage(p, pagesConfig[key]);
      });
    }

function addDiveLinkToPage(pageNumber, cfg) {
  // åŸæœ¬å®£å‘Š linkEl çš„é‚£æ®µâ€¦
  let linkEl = document.createElement(cfg.imagePath ? 'img' : 'div');
  if (cfg.imagePath) linkEl.src = cfg.imagePath;
  linkEl.style.position = 'absolute';
  linkEl.style.left   = cfg.left;
  linkEl.style.top    = cfg.top;
  linkEl.style.width  = cfg.width;
  linkEl.style.height = cfg.height;
  linkEl.style.zIndex = '1000';
  linkEl.style.cursor = 'pointer';

  // **æ–°å¢ï¼šæ””æˆª touchstartã€touchendï¼Œé¿å… Turn.js ç¿»é **
  linkEl.addEventListener('touchstart', function(e) {
    e.stopPropagation();
    // e.preventDefault(); // å¦‚æœæœ‰éœ€è¦ä¹Ÿå¯ä»¥åŠ ä¸Š
  });
  linkEl.addEventListener('touchend', function(e) {
    e.stopPropagation();
    // e.preventDefault();
    // ä¹‹å¾Œæ‰åŸ·è¡Œé»æ“Šé‚è¼¯â€¦ï¼ˆå¯è·Ÿ click å…±ç”¨åŒä¸€æ®µï¼‰
    try {
      let diveFrame = document.getElementById('dive-frame');
      const diveLinker = new DiveLinker("dive");
      diveLinker.setProject(cfg.projectId);
      diveLinker.start();
      document.getElementById('dive-container').style.display = 'flex';
    } catch (err) {
      console.error('DIVE åˆå§‹åŒ–å¤±æ•—ï¼š', err);
    }
  });

  // åŸæœ¬çš„ click ç›£è½ä¹Ÿä¿ç•™ä»¥é˜²æ¡Œæ©Ÿä½¿ç”¨è€…é»æ“Šï¼š
  linkEl.addEventListener('click', function(e) {
    e.stopPropagation();
    e.preventDefault();
    try {
      let diveFrame = document.getElementById('dive-frame');
      const diveLinker = new DiveLinker("dive");
      diveLinker.setProject(cfg.projectId);
      diveLinker.start();
      document.getElementById('dive-container').style.display = 'flex';
    } catch (err) {
      console.error('DIVE åˆå§‹åŒ–å¤±æ•—ï¼š', err);
    }
  });

  // æŠŠ linkEl append åˆ°è©²é é¢
  let pageEl = $(`#flipbook .page[data-page="${pageNumber}"]`);
  if (pageEl.length) {
    pageEl.append(linkEl);
    linkRegions.push({ pageNumber, element: linkEl, config: cfg });
  }
}


    // ========== æ’å…¥ Embed é€£çµ ==========
    function handleEmbedLinks(view, pagesConfig) {
      view.forEach(p => {
        let key = p.toString();
        if (pagesConfig[key]) addEmbedLinkToPage(p, pagesConfig[key]);
      });
    }

    function addEmbedLinkToPage(pageNumber, cfg) {
      let linkEl = document.createElement('div');
      linkEl.classList.add('link-region');
      linkEl.style.position = 'absolute';
      linkEl.style.left = cfg.left;
      linkEl.style.top = cfg.top;
      linkEl.style.width = cfg.width;
      linkEl.style.height = cfg.height;
      linkEl.style.zIndex = '1000';
      linkEl.style.backgroundColor = 'rgba(0, 0, 255, 0)';

      linkEl.addEventListener('click', e => {
        e.stopPropagation();
        let embedFrame = document.getElementById('embed-frame');
        if (embedFrame) {
          embedFrame.src = cfg.url;
          document.getElementById('embed-container').style.display = 'flex';
        } else {
          console.error('æ‰¾ä¸åˆ° embed-frame');
        }
      });

      let pageEl = $(`#flipbook .page[data-page="${pageNumber}"]`);
      if (pageEl.length) {
        pageEl.append(linkEl);
        linkRegions.push({ pageNumber, element: linkEl, config: cfg });
      }
    }

    // ========== æ›´æ–°é€²åº¦æ¢é¡¯ç¤º ==========
    function updateProgressBar() {
      let current = __CURRENT_PAGE;
      if ($('#flipbook').turn('display') === 'single' && current > 1) {
        current = current - 1;
      }
      let val = (current / __TOTAL_PAGES) * 100;
      document.getElementById('reading-progress').value = val;
      document.getElementById('pdf-current-page').textContent = __CURRENT_PAGE;
    }

    // ========== èª¿æ•´ç¿»é å™¨ & Canvas å¤§å° & ç®­é ­æŒ‰éˆ• ==========
    function ResizeflipCanvasSize() {
      if (!__PAGE_WIDTH || !__PAGE_HEIGHT) return;
      let ratio = window.innerWidth / window.innerHeight;
      let scaleFactor;

      // é™åˆ¶ã€Œå è¦–çª— 80%ã€çš„ç¸®æ”¾é‚è¼¯
      if (ratio < 1) {
        // çª„å±ï¼šå–®é æ¨¡å¼ï¼Œå–®é æœ€å¤§å¯¬åº¦ â‰¦ è¦–çª— 80%
        scaleFactor = ($(window).width() * 0.95) / __PAGE_WIDTH;
        $('#flipbook').turn('display', 'single');
        $('#flipbook').turn('size', __PAGE_WIDTH * scaleFactor, __PAGE_HEIGHT * scaleFactor);
      } else {
        // å¯¬å±ï¼šé›™é æ¨¡å¼ï¼Œé›™é ç¸½å¯¬åº¦ â‰¦ è¦–çª— 80%
        scaleFactor = ($(window).width() * 0.95) / (__PAGE_WIDTH * 2);
        $('#flipbook').turn('display', 'double');
        $('#flipbook').turn('size', __PAGE_WIDTH * 2 * scaleFactor, __PAGE_HEIGHT * scaleFactor);
      }

      // çµ±ä¸€èª¿æ•´æ‰€æœ‰ <canvas> çš„ CSS å°ºå¯¸
      $('#flipbook canvas').each(function() {
        $(this).css({
          width: __PAGE_WIDTH * scaleFactor + 'px',
          height: __PAGE_HEIGHT * scaleFactor + 'px'
        });
      });

      // è®“ç¿»é å™¨ (#flipbook) åœ¨å…¶çˆ¶å®¹å™¨ä¸­ä¿æŒæ°´å¹³ç½®ä¸­
      $('#flipbook').css('margin', '20px auto');

      // èª¿æ•´å·¦å³ç®­é ­æŒ‰éˆ•åˆ°ç¿»é å™¨å…©å´
      adjustArrowButtons();
    }

    // ========== å°‡å·¦å³ç®­é ­æŒ‰éˆ•å®šä½åˆ°ç¿»é å™¨å…©å´ ==========
    function adjustArrowButtons() {
      let flipEl = $('#flipbook');
      let offset = flipEl.offset();
      let fbW = flipEl.outerWidth();
      let fbH = flipEl.outerHeight();
      let btnOff = 20; 

      if (!offset) return;

      $('#pdf-prev').css({
        top: offset.top + fbH / 2 - $('#pdf-prev').outerHeight() / 2 + 'px',
        left: offset.left - $('#pdf-prev').outerWidth() - btnOff + 'px'
      });
      $('#pdf-next').css({
        top: offset.top + fbH / 2 - $('#pdf-next').outerHeight() / 2 + 'px',
        left: offset.left + fbW + btnOff + 'px'
      });
    }

    // ========== é—œé–‰ / é‡æ–°æ•´ç† DIVE ==========
    function closeDive() {
      document.getElementById('dive-container').style.display = 'none';
      document.getElementById('dive-frame').src = '';
    }
    function restartDive() {
      let f = document.getElementById('dive-frame');
      f.src = f.src;
    }

    // ========== é—œé–‰ / é‡æ–°æ•´ç† Embed ==========
    function closeEmbed() {
      document.getElementById('embed-container').style.display = 'none';
      document.getElementById('embed-frame').src = '';
    }
    function reloadEmbed() {
      let f = document.getElementById('embed-frame');
      f.src = f.src;
    }

    // ========== ç¶å®šå·¦å³ç¿»é æŒ‰éˆ• ==========
    $('#pdf-prev').on('click', () => { $('#flipbook').turn('previous'); });
    $('#pdf-next').on('click', () => { $('#flipbook').turn('next'); });

    // ========== æ’­æ”¾æœ—è®€éŸ³è¨Š (.m4a) ==========
    function setupAudioButton() {
      document.getElementById('play-audio').addEventListener('click', () => {
        let pageNum = __CURRENT_PAGE;
        let audioFile;
        if (pageNum === 1) {
          audioFile = 'page1.m4a';
        } else {
          let groupStart = (pageNum % 2 === 0) ? pageNum : (pageNum - 1);
          audioFile = `page${groupStart}.m4a`;
        }
        let audioEl = document.getElementById('page-audio');
        audioEl.src = `audio/${audioFile}`;
        audioEl.play().catch(err => console.warn('æ’­æ”¾å¤±æ•—ï¼š', err));
      });
    }

    // ========== åˆå§‹åŒ– & Loading é‚è¼¯ ==========
    function showLoading() {
      document.getElementById('loading-screen').style.display = 'flex';
      document.getElementById('app-content').style.display = 'none';
    }
    function hideLoading() {
      document.getElementById('loading-screen').style.display = 'none';
      document.getElementById('app-content').style.display = 'block';
    }
    function loadData() {
      return new Promise(resolve => {
        setTimeout(() => {
          console.log('æ¨¡æ“¬è³‡æ–™è¼‰å…¥å®Œæˆ');
          resolve();
        }, 3000);
      });
    }
    function initializeApp() {
      showLoading();
      loadData().then(() => {
        hideLoading();
        showPDF();
      });
    }

    // ========== DOM Ready & Window Load ==========
    $(document).ready(() => {
      setupAudioButton();

      // ç€è¦½å™¨å¤§å°æ”¹è®Šæ™‚ï¼Œä¸€ä½µæ›´æ–°ç¿»é å™¨èˆ‡é€²åº¦æ¢
      $(window).resize(() => {
        ResizeflipCanvasSize();
        updateProgressBar();
      });

      // turn.js å®Œæˆä¸€ç¿»é å¾Œï¼Œä¹Ÿæ›´æ–°é€²åº¦æ¢ & ç¸®æ”¾ & é€£çµä½ç½®
      $('#flipbook').bind('turned', () => {
        updateProgressBar();
        ResizeflipCanvasSize();
        adjustLinkRegions();
      });
    });

    window.addEventListener('load', initializeApp);

    // ========== èª¿æ•´æ‰€æœ‰ DIVE/Embed é€£çµå€åŸŸä½ç½® ==========
    function adjustLinkRegions() {
      let ratio = window.innerWidth / window.innerHeight;
      let scaleF = (ratio < 1)
        ? ($(window).width() * 0.8 / __PAGE_WIDTH)         // å–®é æ¨¡å¼ç¸®æ”¾
        : ($(window).width() * 0.8 / (__PAGE_WIDTH * 2));  // é›™é æ¨¡å¼ç¸®æ”¾

      linkRegions.forEach(item => {
        let cfg = item.config;
        let el = $(item.element);
        if (cfg.left && cfg.top && cfg.width && cfg.height) {
          el.css({
            left: parseFloat(cfg.left) * scaleF + 'px',
            top: parseFloat(cfg.top) * scaleF + 'px',
            width: parseFloat(cfg.width) * scaleF + 'px',
            height: parseFloat(cfg.height) * scaleF + 'px'
          });
        }
      });
    }
  </script>
</body>
</html>
